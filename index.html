<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GITECH PDF Data Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom styles for smooth transition and sidebar behavior */
        .sidebar-panel {
            transition: all 0.3s ease-in-out;
            min-width: 0;
        }

        /* Hidden state for mobile */
        .sidebar-hidden {
            transform: translateX(-100%);
            width: 0;
            opacity: 0;
        }

        /* Visible state for mobile */
        .sidebar-visible {
            transform: translateX(0);
            width: 320px; /* Fixed width for the sidebar */
            opacity: 1;
        }
        
        /* Set PDF.js worker source */
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        /* Custom scrollbar styling for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
    </style>
</head>
<body class="bg-gray-100 font-inter">

    <div id="app" class="flex h-screen overflow-hidden">

        <!-- Sidebar Toggle Button (Visible on small screens) -->
        <button id="sidebar-toggle" class="md:hidden fixed top-4 left-4 z-30 p-2 bg-indigo-600 text-white rounded-full shadow-lg transition duration-150 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Toggle Sidebar">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
            </svg>
        </button>

        <!-- Sidebar: File List Panel -->
        <div id="sidebar" class="sidebar-panel bg-white border-r border-gray-200 shadow-2xl z-20 fixed md:relative h-full sidebar-hidden md:sidebar-visible">
            <div class="p-4 flex items-center justify-between border-b">
                <h2 class="text-xl font-bold text-indigo-600">Saved Files</h2>
                <button id="sidebar-close" class="md:hidden text-gray-500 hover:text-gray-700 p-1 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="file-list-container" class="overflow-y-auto p-4 space-y-3 h-[calc(100vh-65px)]">
                <!-- File list items will be injected here -->
                <div class="text-center text-sm text-gray-500 mt-4" id="loading-indicator">
                    Loading files...
                </div>
            </div>
        </div>

        <!-- Main Content Area: Viewer, Editor, and Upload -->
        <div id="main-content" class="flex-grow flex flex-col p-4 overflow-y-auto">
            
            <!-- Header and Upload -->
            <header class="mb-6 pb-4 border-b border-gray-200">
                <h1 class="text-3xl font-extrabold text-gray-900">GITECH PDF Data Extractor</h1>
            </header>

            <div id="upload-section" class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <label for="pdf-upload" class="block text-sm font-medium text-gray-700 mb-2">Upload a Service Slip PDF:</label>
                <input type="file" id="pdf-upload" accept="application/pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <p id="upload-status" class="mt-2 text-sm text-gray-600 hidden"></p>
            </div>

            <!-- Editor and Viewer Container -->
            <div id="document-display" class="flex flex-col lg:flex-row flex-grow gap-6">

                <!-- PDF Viewer Panel -->
                <div id="viewer-panel" class="lg:w-1/2 bg-white p-4 rounded-xl shadow-lg border border-gray-200 overflow-hidden" style="min-height: 400px;">
                    <h2 class="text-xl font-semibold mb-3 text-gray-700 border-b pb-2">PDF Viewer</h2>
                    <div id="pdf-viewer" class="w-full h-full overflow-y-auto">
                        <p class="text-center text-gray-400 mt-10">Upload a PDF to view it here.</p>
                    </div>
                </div>

                <!-- Editor Panel -->
                <div id="editor-panel" class="lg:w-1/2 bg-white p-6 rounded-xl shadow-lg border border-indigo-100" style="min-height: 400px;">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Extracted & Editable Data</h2>
                    <div id="data-editor" class="space-y-4">
                        <!-- Form fields will be dynamically added here -->
                        <p class="text-center text-gray-400 mt-10">Extracted data will appear here after a PDF is uploaded.</p>
                    </div>

                    <div class="mt-8 pt-4 border-t">
                        <button id="generate-pdf-btn" class="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50" disabled>
                            Generate and Save PDF
                        </button>
                    </div>
                </div>
            </div>
            <footer class="mt-6 text-center text-gray-500 text-sm py-4 border-t">
                Data is stored in Firestore.
            </footer>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, getDocs, deleteDoc, orderBy, limit, serverTimestamp, where, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        window.app = null;
        window.db = null;
        window.auth = null;
        let userId = null;
        let isAuthReady = false;

        // Global app state
        window.currentEditedData = null;

        // Firebase Setup and Authentication
        async function setupFirebase() {
            try {
                // Mandatory global variables provided by the canvas environment
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Data storage will not work.");
                    return;
                }

                setLogLevel('debug');
                window.app = initializeApp(firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);

                // Sign in with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("User authenticated:", userId);
                        // Start listening to files once auth is ready
                        listenForFiles();
                    } else {
                        // Use a random ID if anonymous sign-in failed (shouldn't happen)
                        userId = crypto.randomUUID();
                        isAuthReady = true;
                        console.log("Signed in anonymously or user not available.");
                        listenForFiles();
                    }
                });

            } catch (error) {
                console.error("Firebase setup error:", error);
            }
        }

        // --- File List Management and Firestore ---

        function getCollectionRef() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // Store files under the user's private space
            return collection(window.db, `artifacts/${appId}/users/${userId}/extracted_files`);
        }

        function listenForFiles() {
            if (!isAuthReady || !userId || !window.db) return;

            const q = query(getCollectionRef());
            
            const fileListContainer = document.getElementById('file-list-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = 'block';

            onSnapshot(q, (snapshot) => {
                fileListContainer.innerHTML = '';
                if (snapshot.empty) {
                    fileListContainer.innerHTML = '<p class="text-center text-gray-500 mt-4">No saved files yet. Upload a PDF to start!</p>';
                } else {
                    snapshot.docs.forEach(doc => {
                        const fileData = doc.data();
                        const fileItem = createFileListItem(doc.id, fileData);
                        fileListContainer.appendChild(fileItem);
                    });
                }
                loadingIndicator.style.display = 'none';
            }, (error) => {
                console.error("Error listening to files:", error);
                fileListContainer.innerHTML = '<p class="text-red-500 text-center mt-4">Error loading files.</p>';
                loadingIndicator.style.display = 'none';
            });
        }

        function createFileListItem(docId, data) {
            const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : 'N/A';

            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-3 bg-gray-50 hover:bg-indigo-50 rounded-lg cursor-pointer transition duration-150 border border-gray-200';
            div.innerHTML = `
                <div>
                    <p class="font-medium text-gray-900 truncate max-w-[200px]">${data.clientName || 'Unnamed Client'}</p>
                    <p class="text-xs text-gray-500">Project: ${data.projectNumber || 'N/A'}</p>
                    <p class="text-xs text-gray-500">Date: ${date}</p>
                </div>
                <button data-id="${docId}" class="delete-btn p-2 text-red-500 hover:bg-red-100 rounded-full" title="Delete File">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            `;
            
            // Add event listeners for edit/delete
            div.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent the main div click
                deleteFile(docId);
            });

            div.addEventListener('click', () => {
                loadFileForEditing(docId, data);
            });

            return div;
        }

        async function deleteFile(docId) {
            if (!window.db || !userId) return;

            // Use a custom confirmation modal instead of window.confirm
            if (!confirm("Are you sure you want to delete this file?")) return;

            try {
                const docRef = doc(getCollectionRef(), docId);
                await deleteDoc(docRef);
                console.log("Document successfully deleted:", docId);
                // Optional: Clear editor/viewer if the deleted file was currently loaded
                window.currentEditedData = null;
                document.getElementById('data-editor').innerHTML = '<p class="text-center text-gray-400 mt-10">Extracted data will appear here after a PDF is uploaded.</p>';
                document.getElementById('generate-pdf-btn').disabled = true;
            } catch (error) {
                console.error("Error removing document:", error);
            }
        }

        function loadFileForEditing(docId, data) {
            window.currentEditedData = { ...data, docId };
            renderEditor(window.currentEditedData);
            
            // On mobile, close sidebar after selecting a file
            if (window.innerWidth < 768) {
                toggleSidebar(false);
            }
        }

        // --- PDF Upload and Text Extraction ---

        async function extractText(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdfDocument = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            let fullText = '';
            for (let i = 1; i <= pdfDocument.numPages; i++) {
                const page = await pdfDocument.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ') + '\n';
            }
            return fullText;
        }

        function parseTextForData(text) {
            const data = {};
            
            // Regex patterns based on the structure of the GITECH slip
            data.dateOfSlip = text.match(/Date\s+التاريخ\s+([0-9/.]+)/)?.[1]?.trim() || '';
            data.clientName = text.match(/Client\s+اسم العميل\s+([a-zA-Z\s]+)/)?.[1]?.trim() || '';
            data.projectNumber = text.match(/Project\/Job\/\s+([A-Za-z0-9/\-]+)/)?.[1]?.trim() || '';
            data.clientAccount = text.match(/Client Account #\s+([0-9]+)/)?.[1]?.trim() || '';

            // Clean up extracted data (e.g., replace dots with slashes for dates)
            if (data.dateOfSlip) data.dateOfSlip = data.dateOfSlip.replace(/\./g, '/');
            
            return data;
        }

        function displayPDF(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const pdfViewer = document.getElementById('pdf-viewer');
                pdfViewer.innerHTML = ''; // Clear previous content

                const arrayBuffer = e.target.result;
                const pdfDocument = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                for (let i = 1; i <= pdfDocument.numPages; i++) {
                    const page = await pdfDocument.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    canvas.className = 'shadow-md border border-gray-300 mb-4 mx-auto';
                    
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    await page.render(renderContext).promise;
                    pdfViewer.appendChild(canvas);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function renderEditor(data) {
            const editorDiv = document.getElementById('data-editor');
            editorDiv.innerHTML = '';
            
            const fields = [
                { id: 'dateOfSlip', label: 'Date of Slip', type: 'text' },
                { id: 'clientName', label: 'Client Name', type: 'text' },
                { id: 'projectNumber', label: 'Project Number', type: 'text' },
                { id: 'clientAccount', label: 'Client Account #', type: 'text' },
            ];

            fields.forEach(field => {
                const value = data[field.id] || '';
                const inputGroup = document.createElement('div');
                inputGroup.className = 'mb-4';
                inputGroup.innerHTML = `
                    <label for="${field.id}" class="block text-sm font-medium text-gray-700">${field.label}</label>
                    <input type="${field.type}" id="${field.id}" value="${value}" 
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                `;
                editorDiv.appendChild(inputGroup);
            });
            
            // Add input change listener to update currentEditedData
            editorDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', (e) => {
                    window.currentEditedData[e.target.id] = e.target.value;
                });
            });

            document.getElementById('generate-pdf-btn').disabled = false;
        }

        async function handleUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const status = document.getElementById('upload-status');
            status.textContent = 'Processing PDF...';
            status.classList.remove('hidden', 'text-red-500');
            status.classList.add('text-blue-500');

            try {
                // 1. Display PDF in the viewer
                displayPDF(file);

                // 2. Extract and Parse Text
                const fullText = await extractText(file);
                const extractedData = parseTextForData(fullText);
                
                // 3. Store and Render Data
                window.currentEditedData = { ...extractedData };
                renderEditor(extractedData);

                // 4. Save to Firestore (optional for new uploads, but good to keep it)
                if (window.db && userId) {
                    const docRef = await addDoc(getCollectionRef(), {
                        ...extractedData,
                        timestamp: serverTimestamp(),
                    });
                    window.currentEditedData.docId = docRef.id; // Update with new doc ID
                }

                status.textContent = 'Data extracted and loaded successfully. Ready to edit!';
                status.classList.remove('text-blue-500');
                status.classList.add('text-green-500');

            } catch (error) {
                console.error("Error processing file:", error);
                status.textContent = 'Error processing PDF: ' + error.message;
                status.classList.remove('text-blue-500');
                status.classList.add('text-red-500');
                document.getElementById('generate-pdf-btn').disabled = true;
                document.getElementById('data-editor').innerHTML = '<p class="text-center text-gray-400 mt-10">Extraction failed. Check console for details.</p>';
            }
        }

        // --- PDF Generation (jsPDF) ---

        function generatePDF() {
            if (!window.currentEditedData) return;
            
            const editedData = window.currentEditedData;
            
            // Check for jsPDF availability
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                 console.error("jsPDF library not loaded.");
                 // Use custom modal instead of alert
                 showCustomMessage('Error', 'The PDF generation library is not loaded correctly. Please check your network connection.');
                 return;
            }

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            const margin = 10;
            let currentY = 20;
            const lineHeight = 10;

            // 1. Header
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(20);
            pdf.setTextColor(30, 58, 138); // Dark Blue (indigo-800 equivalent)
            pdf.text('GITECH Service Slip Data', margin, currentY);
            currentY += lineHeight;
            
            pdf.line(margin, currentY, 200, currentY); // Draw a separator line
            currentY += lineHeight / 2;

            // 2. Extracted Data
            pdf.setFontSize(12);
            pdf.setTextColor(0, 0, 0); // Black

            // Date
            pdf.setFont('helvetica', 'bold');
            pdf.text('Date of Slip:', margin, currentY);
            pdf.setFont('helvetica', 'normal');
            pdf.text(editedData.dateOfSlip, margin + 40, currentY);
            currentY += lineHeight;

            // Client Name
            pdf.setFont('helvetica', 'bold');
            pdf.text('Client Name:', margin, currentY);
            pdf.setFont('helvetica', 'normal');
            pdf.text(editedData.clientName, margin + 40, currentY);
            currentY += lineHeight;
            
            // Project Number
            pdf.setFont('helvetica', 'bold');
            pdf.text('Project Number:', margin, currentY);
            pdf.setFont('helvetica', 'normal');
            pdf.text(editedData.projectNumber, margin + 40, currentY);
            currentY += lineHeight;

            // Client Account
            pdf.setFont('helvetica', 'bold');
            pdf.text('Client Account:', margin, currentY);
            pdf.setFont('helvetica', 'normal');
            pdf.text(editedData.clientAccount, margin + 40, currentY);
            currentY += lineHeight * 2;
            
            // 3. Footer / Note
            pdf.setFontSize(10);
            pdf.setTextColor(100, 100, 100); // Gray
            pdf.text('This document was generated using the GITECH PDF Data Extractor application.', margin, 280);

            // 4. Save the document - **MODIFIED FILENAME LOGIC**
            // Filename: SERVICE_SLIP_[ProjectNumber]_[DateOfSlip].pdf
            const datePart = editedData.dateOfSlip.replace(/\//g, '-').replace(/\s/g, ''); // 26/08/20 -> 26-08-20
            const projectPart = editedData.projectNumber.replace(/\//g, '-').replace(/\s/g, '');
            const fileName = `SERVICE_SLIP_${projectPart}_${datePart}.pdf`;
            
            pdf.save(fileName);
        }
        
        // --- Sidebar Logic ---
        
        function toggleSidebar(force) {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle');
            
            const isVisible = sidebar.classList.contains('sidebar-visible');
            let shouldBeVisible = typeof force === 'boolean' ? force : !isVisible;

            if (shouldBeVisible) {
                sidebar.classList.remove('sidebar-hidden');
                sidebar.classList.add('sidebar-visible');
                // Change icon to 'X' (close)
                toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>`;
            } else {
                sidebar.classList.remove('sidebar-visible');
                sidebar.classList.add('sidebar-hidden');
                // Change icon back to 'Hamburger' (menu)
                toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>`;
            }
        }
        
        // --- Initialization and Event Listeners ---

        document.addEventListener('DOMContentLoaded', async () => {
            // Setup Firebase and start listening for data
            await setupFirebase();

            // Set up event listeners
            document.getElementById('pdf-upload').addEventListener('change', handleUpload);
            document.getElementById('generate-pdf-btn').addEventListener('click', generatePDF);
            
            // Sidebar event listeners
            document.getElementById('sidebar-toggle').addEventListener('click', () => toggleSidebar());
            document.getElementById('sidebar-close').addEventListener('click', () => toggleSidebar(false));

            // Initial sidebar state for responsiveness
            if (window.innerWidth >= 768) {
                toggleSidebar(true); // Open by default on desktop
            } else {
                toggleSidebar(false); // Closed by default on mobile
            }
        });

        // Simple custom message function (instead of alert)
        function showCustomMessage(title, message) {
            console.warn(title, message);
            // In a real app, you would render a modal here.
            document.getElementById('upload-status').textContent = `${title}: ${message}`;
            document.getElementById('upload-status').classList.remove('hidden');
            document.getElementById('upload-status').classList.add('text-red-500');
        }

    </script>
</body>
</html>
