<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GITECH PDF Data Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- NEW: Include pdf-lib for merging capabilities -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.js"></script> 
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // ADDED: onSnapshot, collection, query for loading saved documents
        import { getFirestore, setDoc, doc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // Global Firebase variables
        window.app = null;
        window.db = null;
        window.auth = null;
        
        // Custom Firebase Config provided by the user
        const CUSTOM_FIREBASE_CONFIG = {
            apiKey: "AIzaSyA_RhnNogN-l45mcrSfKbfipkMYkpfDxrc",
            authDomain: "gitechslip.firebaseapp.com",
            projectId: "gitechslip",
            storageBucket: "gitechslip.firebasestorage.app",
            messagingSenderId: "577549935977",
            appId: "1:577549935977:web:fba329f423a895469049f8",
            measurementId: "G-S11NLH0TYX"
        };


        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config) 
                    : CUSTOM_FIREBASE_CONFIG;
                
                if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
                    window.app = initializeApp(firebaseConfig);
                    window.db = getFirestore(window.app);
                    window.auth = getAuth(window.app);

                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                        console.log("Firebase signed in with custom token.");
                    } else {
                        await signInAnonymously(window.auth);
                        console.log("Firebase signed in anonymously.");
                    }
                    console.log(`Firestore initialized. App ID: ${appId}`);
                    
                    // NEW: Start listening for saved files after successful auth
                    loadSavedFiles(); 
                } else {
                    console.warn("Firebase configuration not fully available. Proceeding without database storage.");
                }
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        });
        
        // Exporting Firestore functions globally for use outside the module script
        window.setDoc = setDoc;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
    </script>
    <style>
        /* Custom styles for better aesthetics and loading visibility */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .spinner {
            border-top-color: #EF4444; /* GITECH Red accent */
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .raw-text-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.8rem;
        }

        /* Custom Tailwind colors based on GITECH logo */
        .bg-gitech-red { background-color: #EF4444; } 
        .hover\:bg-gitech-red-dark:hover { background-color: #DC2626; } 
        .text-gitech-red { color: #EF4444; }
        .border-gitech-red { border-color: #EF4444; }

        .bg-gitech-yellow-light { background-color: #FEF3C7; }
        .text-gitech-black { color: #1A1A1A; }
        
        .focus\:ring-gitech-red:focus { --tw-ring-color: #EF4444; }
        .focus\:border-gitech-red:focus { border-color: #EF4444; }
        
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">
    <!-- MODIFIED: Container for the grid layout -->
    <div id="main-content" class="max-w-6xl mx-auto">
        <header class="text-center mb-10 md:col-span-3">
            <h1 class="text-4xl font-extrabold text-gitech-black">GITECH PDF Data Extractor</h1>
            <div id="message-box" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg hidden"></div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <!-- LEFT COLUMN: Saved Documents List (1/3 Width on Desktop) -->
            <div id="sidebar" class="md:col-span-1">
                <h2 class="text-2xl font-bold text-gitech-black mb-4 border-b pb-2 border-gitech-red">Saved Documents</h2>
                <div id="saved-files-container" 
                     class="bg-white p-4 rounded-xl shadow-lg border border-gray-200 h-96 overflow-y-auto">
                    <p class="text-sm text-gray-500">Loading saved slips...</p>
                </div>
            </div>

            <!-- RIGHT COLUMN: Upload and Results Area (2/3 Width on Desktop) -->
            <div id="main-app" class="md:col-span-2 space-y-8">
                
                <!-- File Upload Section with Clear Button -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gitech-red">
                    <label for="pdf-upload" class="block text-lg font-medium text-gray-700 mb-3">Upload PDF Files</label>
                    <div class="flex items-center space-x-4">
                        <input type="file" id="pdf-upload" multiple accept=".pdf" 
                            class="flex-grow w-full text-sm text-gray-500
                                    file:mr-4 file:py-2 file:px-4
                                    file:rounded-full file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-gitech-yellow-light file:text-gitech-black
                                    hover:file:bg-yellow-100 cursor-pointer"
                            onchange="handleFileSelect(event)">
                        <!-- Clear Button calls the new clearFiles() function -->
                        <button onclick="clearFiles()" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg text-sm font-medium hover:bg-gray-300 transition duration-150 whitespace-nowrap">Clear</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Select one or multiple scanned PDF files.</p>
                </div>
                
                <div id="loading-indicator" class="hidden text-center p-6 bg-yellow-50 rounded-xl shadow-md">
                    <div class="spinner border-4 border-solid border-gray-200 h-10 w-10 rounded-full mx-auto mb-3"></div>
                    <p class="text-lg font-medium text-gitech-black">Sending image to Gemini for advanced data extraction... Please wait.</p>
                </div>

                <div id="results-container" class="space-y-8 mt-10">
                    <p class="text-center text-gray-500 p-8 border border-dashed rounded-lg">Upload a PDF to begin extraction.</p>
                </div>

            </div>
        </div>

        <canvas id="pdf-canvas" class="hidden"></canvas>
    </div>

    <script>
        // =========================================================================
        // API Configuration (FIXED SCOPE AND KEY)
        // =========================================================================
        
        const apiKey = 'AIzaSyD96luWwd2cNjPiAAqlkrJ_4dLI8E_kLWk'; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // =========================================================================
        // END API Configuration
        // =========================================================================

        let extractionResults = [];
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsContainer = document.getElementById('results-container');
        const messageBox = document.getElementById('message-box');
        
        // Set PDF.js worker source
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // --- Helper function to fetch the original PDF file as an ArrayBuffer. ---
        window.fetchOriginalPdfFile = async function(fileName) {
            const files = document.getElementById('pdf-upload').files;
            const file = Array.from(files).find(f => f.name === fileName);

            if (!file) {
                throw new Error(`Original file '${fileName}' not found in upload list.`);
            }

            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // --- Saves the extracted data to the Firestore database. ---
        window.saveToFirestore = async function(editedData, fileName) {
            if (!window.db) {
                console.warn("Firestore not initialized. Skipping database save.");
                return;
            }
            
            // Clean the clientAccount to prevent the '/' character from being interpreted
            const docId = editedData.clientAccount.replace(/\//g, '_'); 
            
            const dataToSave = {
                fileName: fileName,
                timestamp: new Date().toISOString(),
                ...editedData 
            };
            
            const userId = window.auth.currentUser?.uid || 'anonymous';
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            try {
                // Path: /artifacts/{appId}/users/{userId}/client_data/{docId}
                const docRef = window.doc(
                    window.db, 
                    `artifacts/${appId}/users/${userId}/client_data`, 
                    docId
                );
                
                await window.setDoc(docRef, dataToSave, { merge: true });
                
                console.log(`Document successfully written to client_data/${docId} by user ${userId}.`);
            } catch (e) {
                console.error("Error writing document to Firestore:", e);
                throw new Error("Failed to save data to database.");
            }
        }
        
        // --- NEW: Loads saved documents from Firestore and groups them by Client Account. ---
        window.loadSavedFiles = function() {
            const container = document.getElementById('saved-files-container');
            if (!window.db) {
                container.innerHTML = '<p class="text-sm text-red-500">Database not available.</p>';
                return;
            }
            
            const userId = window.auth.currentUser?.uid || 'anonymous';
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            // Path: /artifacts/{appId}/users/{userId}/client_data/
            const colRef = window.collection(window.db, `artifacts/${appId}/users/${userId}/client_data`);
            const q = window.query(colRef); 

            window.onSnapshot(q, (snapshot) => {
                const groupedData = {};
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Group by Client Account, default to 'Uncategorized' if missing
                    const account = data.clientAccount || 'Uncategorized';
                    
                    if (!groupedData[account]) {
                        groupedData[account] = [];
                    }
                    groupedData[account].push({ id: doc.id, ...data });
                });
                
                renderSavedFiles(groupedData);
            }, (error) => {
                console.error("Error fetching saved documents:", error);
                container.innerHTML = 
                    '<p class="text-red-500 text-sm">Error loading files. Check console.</p>';
            });
        };

        /**
         * Utility to display temporary messages/errors.
         */
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'text-red-700', 'text-green-700');
            messageBox.classList.add(isError ? 'bg-red-100' : 'bg-green-100', isError ? 'text-red-700' : 'text-green-700');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 8000); 
        }

        /**
         * Function to clear the files and the results.
         */
        window.clearFiles = function() {
            const pdfFileInput = document.getElementById('pdf-upload');
            if (pdfFileInput) {
                pdfFileInput.value = ''; // Clear file input
            }
            
            // Reset internal state
            extractionResults = [];
            
            // Reset UI elements
            loadingIndicator.classList.add('hidden');
            resultsContainer.innerHTML = '<p class="text-center text-gray-500 p-8 border border-dashed rounded-lg">Upload a PDF to begin extraction.</p>';
            messageBox.classList.add('hidden');
            messageBox.textContent = ''; 
            
            console.log("Files and results cleared.");
        }
        
        /**
         * Step 1: Handle file selection and start processing.
         */
        window.handleFileSelect = async function(event) {
            if (apiKey === '' || apiKey === 'YOUR_API_KEY_HERE') {
                showMessage("CRITICAL ERROR: API Key is missing. Please insert your Gemini API Key into the 'apiKey' variable in the code.", true);
                return;
            }
            
            const files = event.target.files;
            if (files.length === 0) return;

            extractionResults = [];
            resultsContainer.innerHTML = '';
            
            const filePromises = Array.from(files).map(file => processFileForGemini(file));
            
            try {
                loadingIndicator.classList.remove('hidden');
                
                // Process files sequentially to avoid hitting rate limits too quickly
                const results = [];
                for (const filePromise of filePromises) {
                    const result = await filePromise;
                    if (result) {
                        results.push(result);
                    }
                }

                extractionResults = results;
                renderResults();
                
                if (extractionResults.length > 0) {
                    showMessage(`Successfully processed ${extractionResults.length} file(s) using Gemini AI.`, false);
                } else {
                    showMessage("Processing finished, but 0 documents were successfully extracted. Check console for PDF rendering or API errors.", true);
                }

            } catch (error) {
                console.error("Error during file processing:", error);
                showMessage("A critical error occurred during processing. Check console for details.", true);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Converts a Base64 string into its raw data (excluding the mime type header).
         */
        function base64ToData(base64) {
            const commaIndex = base64.indexOf(',');
            return commaIndex !== -1 ? base64.substring(commaIndex + 1) : base64;
        }

        /**
         * Step 2: Load PDF, convert to image, and call Gemini for extraction.
         */
        async function processFileForGemini(file) {
            const fileReader = new FileReader();
            
            return new Promise((resolve) => {
                fileReader.onload = async () => {
                    try {
                        const arrayBuffer = fileReader.result;
                        
                        // --- 1. PDF Loading ---
                        let pdfDocument;
                        try {
                            pdfDocument = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        } catch (e) {
                            console.error(`[ERROR] PDF.js failed to load document ${file.name}:`, e);
                            showMessage(`Failed to load PDF: ${file.name}. It might be corrupted or password-protected.`, true);
                            return resolve(null);
                        }
                        
                        // --- 2. Page Rendering ---
                        let page;
                        try {
                            page = await pdfDocument.getPage(1);
                        } catch (e) {
                            console.error(`[ERROR] PDF.js failed to get page 1 of ${file.name}:`, e);
                            showMessage(`Failed to get Page 1 from ${file.name}.`, true);
                            return resolve(null);
                        }

                        // Render PDF page to canvas at high resolution
                        const canvas = document.getElementById('pdf-canvas');
                        const viewport = page.getViewport({ scale: 3.0 }); // Increased scale for better detail
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        const renderContext = {
                            canvasContext: canvas.getContext('2d'),
                            viewport: viewport
                        };

                        try {
                            await page.render(renderContext).promise;
                        } catch (e) {
                            console.error(`[ERROR] PDF.js failed to render page of ${file.name}:`, e);
                            showMessage(`Failed to render image for ${file.name}. Ensure PDF content is simple.`, true);
                            return resolve(null);
                        }
                        
                        // Get original image data (Base64) for API and PDF inclusion
                        const originalImageBase64 = canvas.toDataURL('image/jpeg', 0.9);
                        const mimeType = 'image/jpeg';
                        const imageData = base64ToData(originalImageBase64);
                        
                        // --- 3. Gemini API Call ---
                        const extractedFields = await getExtractedDataFromGemini(imageData, mimeType);
                        
                        // Prepare the data structure
                        const extractedText = JSON.stringify(extractedFields, null, 2); 

                        resolve({
                            id: Date.now() + Math.random(), 
                            fileName: file.name,
                            originalImageBase64: originalImageBase64,
                            fields: extractedFields,
                            extractedText: `<pre>${extractedText}</pre>` 
                        });

                    } catch (error) {
                        console.error(`[CRITICAL ERROR] Failed to process file ${file.name}:`, error);
                        showMessage(`Critical error during processing of ${file.name}: ${error.message}`, true);
                        resolve(null); 
                    }
                };
                fileReader.readAsArrayBuffer(file);
            });
        }
        
        /**
         * Step 3: Call the Gemini API to extract structured data from the image.
         */
        async function getExtractedDataFromGemini(imageData, mimeType, maxRetries = 5) {
            
            const systemPrompt = `You are a highly specialized document data extraction system. Your task is to precisely locate and extract the following four fields from the provided scanned document, which may contain both printed and handwritten text:
1. Date Of Slip (Find the date of issue or similar relevant date on the slip.)
2. Client Name (Find the name of the client or recipient.)
3. Project Number (Find the specific identifier for the project.)
4. Client Account (Find the client's account number or reference number.)

Return ONLY a single JSON object with these exact keys: "dateOfSlip", "clientName", "projectNumber", and "clientAccount". If a field cannot be found, use the value "Not Found". Be concise and do not include any explanatory text outside of the JSON block.`;

            const userQuery = "Extract the four required fields from this document. Be sure to return only JSON.";

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userQuery },
                        { inlineData: { mimeType: mimeType, data: imageData } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "dateOfSlip": { "type": "STRING", "description": "The extracted date." },
                            "clientName": { "type": "STRING", "description": "The extracted client name." },
                            "projectNumber": { "type": "STRING", "description": "The extracted project number." },
                            "clientAccount": { "type": "STRING", "description": "The extracted client account number." }
                        },
                        required: ["dateOfSlip", "clientName", "projectNumber", "clientAccount"]
                    }
                },
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            console.warn(`Rate limit hit (429). Retrying in ${Math.round(delay / 1000)}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; 
                        }
                        throw new Error(`HTTP error! status: ${response.status} on attempt ${attempt + 1}`);
                    }

                    const result = await response.json();
                    
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (jsonText) {
                        try {
                            return JSON.parse(jsonText);
                        } catch (e) {
                            console.error("Failed to parse JSON from Gemini response:", jsonText);
                            throw new Error("Invalid JSON structure received from model.");
                        }
                    } else {
                        throw new Error("No text content found in Gemini response.");
                    }
                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        console.error("Gemini API call failed after all retries:", error);
                        throw new Error("Failed to extract data via API.");
                    }
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    console.warn(`Attempt ${attempt + 1} failed. Retrying in ${Math.round(delay / 1000)}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Exhausted all API retries.");
        }

        /**
         * Function to toggle the visibility of the raw OCR text (now the structured JSON).
         */
        window.toggleRawText = function(id) {
            const element = document.getElementById(`raw-text-${id}`);
            const button = document.getElementById(`toggle-btn-${id}`);
            if (element.classList.contains('hidden')) {
                element.classList.remove('hidden');
                button.textContent = 'Hide Extracted JSON';
            } else {
                element.classList.add('hidden');
                button.textContent = 'Show Extracted JSON for Debugging';
            }
        }
        
        // --- NEW: Toggle function for the sidebar groups ---
        window.toggleGroup = function(accountId) {
            const list = document.getElementById(`group-list-${accountId}`);
            const icon = document.getElementById(`icon-${accountId}`);
            
            if (list.classList.contains('hidden')) {
                list.classList.remove('hidden');
                icon.classList.remove('rotate-0');
                icon.classList.add('rotate-90');
            } else {
                list.classList.add('hidden');
                icon.classList.remove('rotate-90');
                icon.classList.add('rotate-0');
            }
        }

        // --- NEW: Renders the saved documents in the sidebar. ---
        function renderSavedFiles(groupedData) {
            const container = document.getElementById('saved-files-container');
            container.innerHTML = '';

            if (Object.keys(groupedData).length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 p-2">No documents saved yet.</p>';
                return;
            }

            // Sort accounts alphabetically
            const sortedAccounts = Object.keys(groupedData).sort();

            sortedAccounts.forEach(account => {
                const slips = groupedData[account];
                const slipCount = slips.length;
                
                // Sanitize account string for use as a DOM ID
                const safeAccountId = account.replace(/[^a-zA-Z0-9]/g, '_'); 

                // Account Header (Collapsible trigger)
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center p-2 cursor-pointer bg-gitech-yellow-light hover:bg-yellow-200 rounded-md mb-1 transition duration-150';
                header.setAttribute('onclick', `toggleGroup('${safeAccountId}')`);

                header.innerHTML = `
                    <span class="font-semibold text-gitech-black text-sm truncate" title="Client Account: ${account}">
                        Account: ${account}
                        <span class="text-xs text-gray-600">(${slipCount})</span>
                    </span>
                    <!-- Icon starts rotated 90 degrees (open) by default -->
                    <svg id="icon-${safeAccountId}" class="w-4 h-4 text-gitech-red transform transition-transform duration-200 rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                `;
                container.appendChild(header);

                // List of Slips (Initially visible)
                const list = document.createElement('ul');
                list.id = `group-list-${safeAccountId}`;
                list.className = 'mb-4 pl-2 space-y-1 text-sm border-l-2 border-gitech-red';
                
                // Sort slips by newest first
                slips.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(slip => {
                    const date = new Date(slip.timestamp).toLocaleDateString();
                    const listItem = document.createElement('li');
                    listItem.className = 'text-xs text-gray-700 hover:text-gitech-red hover:underline cursor-default py-0.5 px-1 rounded-sm transition-colors';
                    listItem.title = `Project: ${slip.projectNumber} | Client: ${slip.clientName}`;
                    listItem.innerHTML = `
                        <span class="font-mono text-gray-500">${date}</span> - ${slip.fileName}
                    `;
                    list.appendChild(listItem);
                });
                
                container.appendChild(list);
            });
        }


        /**
         * Step 4: Render the editable results form.
         */
        function renderResults() {
            resultsContainer.innerHTML = '';
            if (extractionResults.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center text-gray-500 p-8 border border-dashed rounded-lg">Upload a PDF to begin extraction.</p>';
                return;
            }

            extractionResults.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-lg border-t-4 border-gitech-red';
                
                // Get display values
                const dateDisplay = result.fields.dateOfSlip || 'Not Found';
                const clientDisplay = result.fields.clientName || 'Not Found';
                const projectDisplay = result.fields.projectNumber || 'Not Found';
                const accountDisplay = result.fields.clientAccount || 'Not Found'; 

                card.innerHTML = `
                    <h2 class="text-xl font-semibold text-gitech-black mb-4 truncate" title="${result.fileName}">
                        Result ${index + 1}: ${result.fileName}
                    </h2>
                    
                    <div class="mb-6">
                        <p class="text-sm font-medium text-gray-700 mb-2">Original Document Preview (Approx. 50% Height)</p>
                        
                        <!-- MODIFIED: h-96 for 50% view, object-[50%_0%] to start from the top -->
                        <div class="relative w-full h-96 border rounded-lg overflow-hidden shadow-md">
                            <img src="${result.originalImageBase64}" alt="Original PDF Scan" 
                                class="w-full h-auto object-cover object-[50%_0%]">
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <form id="form-${result.id}" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Date Of Slip</label>
                                <input type="text" name="dateOfSlip" value="${dateDisplay}" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-gitech-red focus:border-gitech-red">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Client Name</label>
                                <input type="text" name="clientName" value="${clientDisplay}" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-gitech-red focus:border-gitech-red">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Project Number</label>
                                <input type="text" name="projectNumber" value="${projectDisplay}" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-gitech-red focus:border-gitech-red">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Client Account</label>
                                <input type="text" name="clientAccount" value="${accountDisplay}" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-gitech-red focus:border-gitech-red">
                            </div>
                            <button type="button" 
                                    onclick="generateFinalPDF('${result.id}')"
                                    class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gitech-red hover:bg-gitech-red-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gitech-red transition duration-150 ease-in-out">
                                Save & Export Merged PDF
                            </button>
                        </form>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <button id="toggle-btn-${result.id}" 
                                onclick="toggleRawText('${result.id}')"
                                class="text-xs text-gitech-red hover:text-red-800 font-medium transition duration-150">
                            Show Extracted JSON for Debugging
                        </button>
                        <div id="raw-text-${result.id}" class="hidden mt-2 p-3 bg-gray-50 border rounded-md raw-text-content text-gray-800">
                            ${result.extractedText.trim()}
                        </div>
                    </div>
                `;
                resultsContainer.appendChild(card);
            });
        }


        /**
         * Step 5: Save the results to Firestore and generate the merged PDF.
         */
        window.generateFinalPDF = async function(resultId) {
            // FIX: Access PDFDocument directly from window.pdfLib 
            const PDFDocument = window.pdfLib.PDFDocument;
            
            const result = extractionResults.find(r => r.id.toString() === resultId);
            const form = document.getElementById(`form-${resultId}`);

            if (!result || !form) {
                showMessage("Result or form not found.", true);
                return;
            }

            // 1. Get the edited values from the form
            const editedData = {
                dateOfSlip: form.elements['dateOfSlip'].value.trim(),
                clientName: form.elements['clientName'].value.trim(),
                projectNumber: form.elements['projectNumber'].value.trim(),
                clientAccount: form.elements['clientAccount'].value.trim(),
            };
            
            if (editedData.clientAccount === 'Not Found' || editedData.clientAccount === '') {
                 showMessage("Client Account number is required to save data to the database. Please enter a valid account number.", true);
                 return;
            }

            try {
                // 2. Save Data to Firestore (Database Step)
                await window.saveToFirestore(editedData, result.fileName);
                showMessage(`Data saved to Firestore under Client Account: ${editedData.clientAccount}`, false);
                
                // 3. Generate the Data PDF (The page containing the extracted text)
                const { jsPDF } = window.jspdf;
                const dataPdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

                const pdfWidth = dataPdf.internal.pageSize.getWidth();
                const pdfHeight = dataPdf.internal.pageSize.getHeight();
                const margin = 10;
                const lineHeight = 7;
                let currentY = margin;
                
                // Add the Original Image Preview (First 50% height)
                const imgData = result.originalImageBase64;
                const imgWidth = pdfWidth - 2 * margin;
                const effectiveImgHeight = pdfHeight / 2.5; 

                dataPdf.addImage(imgData, 'JPEG', margin, currentY, imgWidth, effectiveImgHeight);
                currentY += effectiveImgHeight + 5; 

                // Add Extracted/Edited Text
                dataPdf.setFontSize(18);
                dataPdf.setTextColor(26, 26, 26);
                dataPdf.text('Extracted & Edited Slip Data', margin, currentY);
                currentY += lineHeight * 2;
                
                dataPdf.setFontSize(12);
                dataPdf.setTextColor(0, 0, 0);

                // Populate fields in the data PDF
                ['Date Of Slip', 'Client Name', 'Project Number', 'Client Account'].forEach(label => {
                    // Normalize label to match the keys in editedData object
                    const keyMap = {
                        'Date Of Slip': 'dateOfSlip',
                        'Client Name': 'clientName',
                        'Project Number': 'projectNumber',
                        'Client Account': 'clientAccount'
                    };
                    const key = keyMap[label];
                    
                    dataPdf.setFont('helvetica', 'bold');
                    dataPdf.text(`${label}:`, margin, currentY);
                    dataPdf.setFont('helvetica', 'normal');
                    dataPdf.text(editedData[key], margin + 40, currentY);
                    currentY += lineHeight;
                });

                const dataPdfBytes = dataPdf.output('arraybuffer');
                
                // 4. Fetch Original PDF and Merge (Merging Step)
                const originalPdfBuffer = await window.fetchOriginalPdfFile(result.fileName);
                
                // Load original and data PDFs using pdf-lib
                const originalDoc = await PDFDocument.load(originalPdfBuffer);
                const dataDoc = await PDFDocument.load(dataPdfBytes);
                
                // Copy all pages from the new data PDF to the end of the original PDF
                const copiedPages = await originalDoc.copyPages(dataDoc, dataDoc.getPageIndices());
                copiedPages.forEach(page => originalDoc.addPage(page));

                // 5. Save the Merged Document
                const mergedPdfBytes = await originalDoc.save();

                // 6. Normalize filename and initiate download
                const safeDate = editedData.dateOfSlip.replace(/[^a-zA-Z0-9]/g, '').substring(0, 8);
                const safeClient = editedData.clientName.replace(/[^a-zA-Z0-9\s]/g, '').substring(0, 20).trim().replace(/\s/g, '_');
                const safeProject = editedData.projectNumber.replace(/[^a-zA-Z0-9\s]/g, '').trim().replace(/\s/g, '_');
                // Use the cleaned docId for the filename for consistency
                const safeAccount = editedData.clientAccount.replace(/\//g, '_'); 
                const fileName = `MERGED-${safeDate}-${safeClient}-${safeProject}-${safeAccount}.pdf`;
                
                const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage(`Successfully created and downloaded merged PDF: ${fileName}`, false);

            } catch (error) {
                console.error("Error during PDF generation, merging, or Firestore save:", error);
                showMessage(`Error exporting/merging PDF or saving to database: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>
