<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GITECH PDF Data Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        window.app = null;
        window.db = null;
        window.auth = null;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                
                if (Object.keys(firebaseConfig).length > 0) {
                    window.app = initializeApp(firebaseConfig);
                    window.db = getFirestore(window.app);
                    window.auth = getAuth(window.app);

                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                        console.log("Firebase signed in with custom token.");
                    } else {
                        await signInAnonymously(window.auth);
                        console.log("Firebase signed in anonymously.");
                    }
                } else {
                    console.warn("Firebase configuration not found. Proceeding without authentication.");
                }
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        });
    </script>
    <style>
        /* Custom styles for better aesthetics and loading visibility */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .spinner {
            border-top-color: #EF4444; /* GITECH Red accent */
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .raw-text-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.8rem;
        }

        /* Custom Tailwind colors based on GITECH logo */
        .bg-gitech-red { background-color: #EF4444; } /* A vibrant red, adjust if needed */
        .hover\\:bg-gitech-red-dark:hover { background-color: #DC2626; } /* Darker red for hover */
        .text-gitech-red { color: #EF4444; }
        .border-gitech-red { border-color: #EF4444; }

        .bg-gitech-yellow-light { background-color: #FEF3C7; }
        .text-gitech-black { color: #1A1A1A; }
        
        .focus\\:ring-gitech-red:focus { --tw-ring-color: #EF4444; }
        .focus\\:border-gitech-red:focus { border-color: #EF4444; }

    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

    <div id="app-container" class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <!-- GITECH Logo (Base64 encoded for reliability) -->
            <img src="data:image/png;base64,iVBOR0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAk1BMVEX////9/f38/Pz5+fnr6+vm5ubm5uYGBgbPz8/Z2dnLy8vAwMCurq7T09Pg4ODh4eHq6urIyMjW1tbk5OTMzMympqbFxcXKysrExMTj4+PGxsbU1NTe3t7c3t7c3Nzt7e3S0tLHx8fW1tbh4eHV1dXd3d3S0tLf39/g4ODm5ubm5ubl5eXk5OTi4uLg4ODc3Nzb29vR0dHp6enIyMjDwsKDp2WkAAAKUklEQVR4nO2daXeiOhCGY3WvFj1uRAsQQUXUu+P1/3+hN0iCJXFOcm/X2g+kSSZJyWTiZDIZlQCAwGAwGAwGg8FgMBgMBoPBYDAYDAaDwWCo1qgXW7QJ5f/9z7w23/nPrb3n3hfvfF6qK/Wv/u/V/X+/XhX93Xm3Wd17t1ndu2J3XuzWb1eFfvfO92nE//n/d2q/f2j9/9Pq/0/b/279+7279/1P6/8/b//719q/19b/X1j/P1z/v7z/71hX6m9n/d3T73u3a//e2/9+b/z/c2v/v7f/3zP+/7H+/7H+/2tX6W3t/b23/v7X+v6//92v9/2//+4b+f2/8+7b+f/f7x/t+f+r9e3d/v3T72N0/v3b7+N3f//u09f+3ev//tP7/+9v//239/4/0/+P9P/j/3+3/v9v/v279/x/W/3/h/n92/n93/v/H+3+M/v90/t/vF+3/v93/3yX+b8f9/19r/d9b/29r/f+z/m+P+f+f2/9/b/7/x/t/f33/31v/99n//+3/f/f/v33/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/v/3/36qQWAAAAAASUVORK5CYII=" alt="GITECH Lifts & Escalators L.L.C Logo" class="mx-auto h-24 w-auto mb-4">
            <h1 class="text-4xl font-extrabold text-gitech-black">GITECH Document Extractor</h1>
            <div id="message-box" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg hidden"></div>
        </header>

        <!-- File Upload Section -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border border-gitech-red">
            <label for="pdf-upload" class="block text-lg font-medium text-gray-700 mb-3">Upload PDF Files</label>
            <input type="file" id="pdf-upload" multiple accept=".pdf" 
                   class="w-full text-sm text-gray-500
                          file:mr-4 file:py-2 file:px-4
                          file:rounded-full file:border-0
                          file:text-sm file:font-semibold
                          file:bg-gitech-yellow-light file:text-gitech-black
                          hover:file:bg-yellow-100 cursor-pointer"
                   onchange="handleFileSelect(event)">
            <p class="text-xs text-gray-500 mt-2">Select one or multiple scanned PDF files.</p>
        </div>
        
        <!-- Processing/Loading Indicator -->
        <div id="loading-indicator" class="hidden text-center p-6 bg-yellow-50 rounded-xl shadow-md">
            <div class="spinner border-4 border-solid border-gray-200 h-10 w-10 rounded-full mx-auto mb-3"></div>
            <p class="text-lg font-medium text-gitech-black">Sending image to Gemini for advanced data extraction... Please wait.</p>
        </div>

        <!-- Results Display and Editing Form -->
        <div id="results-container" class="space-y-8 mt-10">
            <p class="text-center text-gray-500 p-8 border border-dashed rounded-lg">Upload a PDF to begin extraction.</p>
        </div>

        <!-- Hidden Canvas for PDF Rendering (Required by PDF.js) -->
        <canvas id="pdf-canvas" class="hidden"></canvas>
    </div>

    <script>
        // =========================================================================
        // API Configuration (FIXED SCOPE AND KEY)
        // =========================================================================
        
        // YOUR PROVIDED API KEY IS INSERTED HERE. 
        // This variable MUST be set for your GitHub Pages deployment to work.
        const apiKey = 'AIzaSyD96luWwd2cNjPiAAqlkrJ_4dLI8E_kLWk'; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // =========================================================================
        // END API Configuration
        // =========================================================================

        let extractionResults = [];
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsContainer = document.getElementById('results-container');
        const messageBox = document.getElementById('message-box');
        
        // Set PDF.js worker source
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        /**
         * Utility to display temporary messages/errors.
         */
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'text-red-700', 'text-green-700');
            messageBox.classList.add(isError ? 'bg-red-100' : 'bg-green-100', isError ? 'text-red-700' : 'text-green-700');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 8000); 
        }

        /**
         * Step 1: Handle file selection and start processing.
         */
        async function handleFileSelect(event) {
            if (apiKey === '') {
                showMessage("CRITICAL ERROR: API Key is missing. Please insert your Gemini API Key into the 'apiKey' variable in the code.", true);
                return;
            }
            
            const files = event.target.files;
            if (files.length === 0) return;

            extractionResults = [];
            resultsContainer.innerHTML = '';
            
            const filePromises = Array.from(files).map(file => processFileForGemini(file));
            
            try {
                loadingIndicator.classList.remove('hidden');
                
                // Process files sequentially to avoid hitting rate limits too quickly
                const results = [];
                for (const filePromise of filePromises) {
                    const result = await filePromise;
                    if (result) {
                        results.push(result);
                    }
                }

                extractionResults = results;
                renderResults();
                
                if (extractionResults.length > 0) {
                    showMessage(`Successfully processed ${extractionResults.length} file(s) using Gemini AI.`, false);
                } else {
                    showMessage("Processing finished, but 0 documents were successfully extracted. Check console for PDF rendering or API errors.", true);
                }

            } catch (error) {
                console.error("Error during file processing:", error);
                showMessage("A critical error occurred during processing. Check console for details.", true);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Converts a Base64 string into its raw data (excluding the mime type header).
         */
        function base64ToData(base64) {
            // Find the comma and take the part after it
            const commaIndex = base64.indexOf(',');
            return commaIndex !== -1 ? base64.substring(commaIndex + 1) : base64;
        }

        /**
         * Step 2: Load PDF, convert to image, and call Gemini for extraction.
         */
        async function processFileForGemini(file) {
            const fileReader = new FileReader();
            
            return new Promise((resolve) => {
                fileReader.onload = async () => {
                    try {
                        const arrayBuffer = fileReader.result;
                        
                        // --- 1. PDF Loading ---
                        let pdfDocument;
                        try {
                            pdfDocument = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        } catch (e) {
                            console.error(`[ERROR] PDF.js failed to load document ${file.name}:`, e);
                            showMessage(`Failed to load PDF: ${file.name}. It might be corrupted or password-protected.`, true);
                            return resolve(null);
                        }
                        
                        // --- 2. Page Rendering ---
                        let page;
                        try {
                            page = await pdfDocument.getPage(1);
                        } catch (e) {
                            console.error(`[ERROR] PDF.js failed to get page 1 of ${file.name}:`, e);
                            showMessage(`Failed to get Page 1 from ${file.name}.`, true);
                            return resolve(null);
                        }

                        // Render PDF page to canvas at high resolution
                        const canvas = document.getElementById('pdf-canvas');
                        const viewport = page.getViewport({ scale: 3.0 }); // Increased scale for better detail
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        const renderContext = {
                            canvasContext: canvas.getContext('2d'),
                            viewport: viewport
                        };

                        try {
                            await page.render(renderContext).promise;
                        } catch (e) {
                            console.error(`[ERROR] PDF.js failed to render page of ${file.name}:`, e);
                            showMessage(`Failed to render image for ${file.name}. Ensure PDF content is simple.`, true);
                            return resolve(null);
                        }
                        
                        // Get original image data (Base64) for API and PDF inclusion
                        const originalImageBase64 = canvas.toDataURL('image/jpeg', 0.9);
                        const mimeType = 'image/jpeg';
                        const imageData = base64ToData(originalImageBase64);
                        
                        // --- 3. Gemini API Call ---
                        const extractedFields = await getExtractedDataFromGemini(imageData, mimeType);
                        
                        // Prepare the data structure
                        const extractedText = JSON.stringify(extractedFields, null, 2); // Raw text is now structured JSON

                        resolve({
                            id: Date.now() + Math.random(), // Unique ID
                            fileName: file.name,
                            originalImageBase64: originalImageBase64,
                            extractedText: extractedText,
                            fields: extractedFields
                        });

                    } catch (error) {
                        // Catch any subsequent errors (e.g., from Gemini API)
                        console.error(`[CRITICAL ERROR] Failed to process file ${file.name}:`, error);
                        showMessage(`Critical error during processing of ${file.name}: ${error.message}`, true);
                        resolve(null); // Resolve with null if processing fails
                    }
                };
                fileReader.readAsArrayBuffer(file);
            });
        }
        
        /**
         * Step 3: Call the Gemini API to extract structured data from the image.
         */
        async function getExtractedDataFromGemini(imageData, mimeType, maxRetries = 5) {
            
            const systemPrompt = `You are a highly specialized document data extraction system. Your task is to precisely locate and extract the following four fields from the provided scanned document, which may contain both printed and handwritten text:
1. Date Of Slip (Find the date of issue or similar relevant date on the slip.)
2. Client Name (Find the name of the client or recipient.)
3. Project Number (Find the specific identifier for the project.)
4. Client Account (Find the client's account number or reference number.)

Return ONLY a single JSON object with these exact keys: "dateOfSlip", "clientName", "projectNumber", and "clientAccount". If a field cannot be found, use the value "Not Found". Be concise and do not include any explanatory text outside of the JSON block.`;

            const userQuery = "Extract the four required fields from this document. Be sure to return only JSON.";

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userQuery },
                        { inlineData: { mimeType: mimeType, data: imageData } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "dateOfSlip": { "type": "STRING", "description": "The extracted date." },
                            "clientName": { "type": "STRING", "description": "The extracted client name." },
                            "projectNumber": { "type": "STRING", "description": "The extracted project number." },
                            "clientAccount": { "type": "STRING", "description": "The extracted client account number." }
                        },
                        required: ["dateOfSlip", "clientName", "projectNumber", "clientAccount"]
                    }
                },
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            console.warn(`Rate limit hit (429). Retrying in ${Math.round(delay / 1000)}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; // Retry request
                        }
                        throw new Error(`HTTP error! status: ${response.status} on attempt ${attempt + 1}`);
                    }

                    const result = await response.json();
                    
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (jsonText) {
                        try {
                            return JSON.parse(jsonText);
                        } catch (e) {
                            console.error("Failed to parse JSON from Gemini response:", jsonText);
                            throw new Error("Invalid JSON structure received from model.");
                        }
                    } else {
                        // Handle case where content part is missing but response is ok
                        throw new Error("No text content found in Gemini response.");
                    }
                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        console.error("Gemini API call failed after all retries:", error);
                        throw new Error("Failed to extract data via API.");
                    }
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    console.warn(`Attempt ${attempt + 1} failed. Retrying in ${Math.round(delay / 1000)}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Exhausted all API retries.");
        }

        /**
         * Function to toggle the visibility of the raw OCR text (now the structured JSON).
         */
        function toggleRawText(id) {
            const element = document.getElementById(`raw-text-${id}`);
            const button = document.getElementById(`toggle-btn-${id}`);
            if (element.classList.contains('hidden')) {
                element.classList.remove('hidden');
                button.textContent = 'Hide Extracted JSON';
            } else {
                element.classList.add('hidden');
                button.textContent = 'Show Extracted JSON for Debugging';
            }
        }

        /**
         * Step 4: Render the editable results form.
         */
        function renderResults() {
            resultsContainer.innerHTML = '';
            if (extractionResults.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center text-gray-500 p-8 border border-dashed rounded-lg">Upload a PDF to begin extraction.</p>';
                return;
            }

            extractionResults.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-lg border-t-4 border-gitech-red'; /* Used GITECH red here */
                
                // Get display values, defaulting to "Not Found" if the model failed to find it
                const dateDisplay = result.fields.dateOfSlip || 'Not Found';
                const clientDisplay = result.fields.clientName || 'Not Found';
                const projectDisplay = result.fields.projectNumber || 'Not Found';
                const accountDisplay = result.fields.clientAccount || 'Not Found'; 

                card.innerHTML = `
                    <h2 class="text-xl font-semibold text-gitech-black mb-4 truncate" title="${result.fileName}">
                        Result ${index + 1}: ${result.fileName}
                    </h2>
                    <div class="md:flex md:space-x-6">
                        <!-- Left Side: Original Image Preview -->
                        <div class="md:w-1/2 mb-4 md:mb-0">
                            <p class="text-sm font-medium text-gray-600 mb-2">Original Document (Page 1)</p>
                            <img src="${result.originalImageBase64}" alt="Original PDF Scan" class="w-full h-auto rounded-lg shadow-md border object-contain max-h-64">
                        </div>

                        <!-- Right Side: Editable Form -->
                        <form id="form-${result.id}" class="md:w-1/2 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Date Of Slip</label>
                                <input type="text" name="dateOfSlip" value="${dateDisplay}" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-gitech-red focus:border-gitech-red">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Client Name</label>
                                <input type="text" name="clientName" value="${clientDisplay}" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-gitech-red focus:border-gitech-red">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Project Number</label>
                                <input type="text" name="projectNumber" value="${projectDisplay}" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-gitech-red focus:border-gitech-red">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Client Account</label>
                                <input type="text" name="clientAccount" value="${accountDisplay}" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-gitech-red focus:border-gitech-red">
                            </div>
                            <button type="button" 
                                    onclick="generateFinalPDF('${result.id}')"
                                    class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gitech-red hover:bg-gitech-red-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gitech-red transition duration-150 ease-in-out">
                                Save & Export as PDF
                            </button>
                        </form>
                    </div>
                    
                    <!-- Raw Text Debugging Section (Structured JSON) -->
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <button id="toggle-btn-${result.id}" 
                                onclick="toggleRawText('${result.id}')"
                                class="text-xs text-gitech-red hover:text-red-800 font-medium transition duration-150">
                            Show Extracted JSON for Debugging
                        </button>
                        <div id="raw-text-${result.id}" class="hidden mt-2 p-3 bg-gray-50 border rounded-md raw-text-content text-gray-800">
                            ${result.extractedText.trim()}
                        </div>
                    </div>
                `;
                resultsContainer.appendChild(card);
            });
        }


        /**
         * Step 5: Save the results and generate the new PDF.
         */
        function generateFinalPDF(resultId) {
            const result = extractionResults.find(r => r.id.toString() === resultId);
            const form = document.getElementById(`form-${resultId}`);

            if (!result || !form) {
                showMessage("Result or form not found.", true);
                return;
            }

            // 1. Get the edited values from the form
            const editedData = {
                dateOfSlip: form.elements['dateOfSlip'].value.trim(),
                clientName: form.elements['clientName'].value.trim(),
                projectNumber: form.elements['projectNumber'].value.trim(),
                clientAccount: form.elements['clientAccount'].value.trim(),
            };

            // 2. Normalize filename parts (safe characters only)
            const safeDate = editedData.dateOfSlip.replace(/[^a-zA-Z0-9]/g, '');
            // Limit client name length in filename
            const safeClient = editedData.clientName.replace(/[^a-zA-Z0-9\s]/g, '').substring(0, 20).trim().replace(/\s/g, '_');
            const safeProject = editedData.projectNumber.replace(/[^a-zA-Z0-9\s]/g, '').trim().replace(/\s/g, '_');

            // Include account number in the filename for better organization
            const fileName = `${safeDate}-${safeClient}-${safeProject}-${editedData.clientAccount}.pdf`;

            // 3. Initialize jsPDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const margin = 10;
            const lineHeight = 7;
            let currentY = margin;
            
            // --- A. Add the Original Image ---
            const imgData = result.originalImageBase64;
            const imgProps = pdf.getImageProperties(imgData);
            const imgWidth = pdfWidth - 2 * margin; // Full width minus margins
            const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
            
            // Limit image height to prevent overflow
            const effectiveImgHeight = Math.min(imgHeight, pdfHeight / 2.5);

            pdf.addImage(imgData, 'JPEG', margin, currentY, imgWidth, effectiveImgHeight);
            currentY += effectiveImgHeight + 5; // Add vertical space after image


            // --- B. Add Extracted/Edited Text ---
            pdf.setFontSize(18);
            pdf.setTextColor(26, 26, 26); // Using GITECH black for headers
            pdf.text('Extracted & Edited Slip Data', margin, currentY);
            currentY += lineHeight * 2;
            
            pdf.setFontSize(12);
            pdf.setTextColor(0, 0, 0); // Black

            // Date
            pdf.setFont('helvetica', 'bold');
            pdf.text('Date of Slip:', margin, currentY);
            pdf.setFont('helvetica', 'normal');
            pdf.text(editedData.dateOfSlip, margin + 40, currentY);
            currentY += lineHeight;

            // Client Name
            pdf.setFont('helvetica', 'bold');
            pdf.text('Client Name:', margin, currentY);
            pdf.setFont('helvetica', 'normal');
            pdf.text(editedData.clientName, margin + 40, currentY);
            currentY += lineHeight;
            
            // Project Number
            pdf.setFont('helvetica', 'bold');
            pdf.text('Project Number:', margin, currentY);
            pdf.setFont('helvetica', 'normal');
            pdf.text(editedData.projectNumber, margin + 40, currentY);
            currentY += lineHeight;

            // Client Account
            pdf.setFont('helvetica', 'bold');
            pdf.text('Client Account:', margin, currentY);
            pdf.setFont('helvetica', 'normal');
            pdf.text(editedData.clientAccount, margin + 40, currentY);
            currentY += lineHeight;
            
            // 4. Save the document
            pdf.save(fileName);
            showMessage(`Successfully saved: ${fileName}`, false);
        }

    </script>
</body>
</html>
